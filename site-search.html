<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adam's search page</title>

  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Comic Sans MS", "Comic Sans", "Patrick Hand", cursive;
      background-image: url('archway.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;

      color: blue;
      font-size: 1.25em;
      text-align: left;
      padding: 20px;
    }

    h2 {
      font-size: 2.2em;
      text-transform: lowercase;
      background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      color: #e0bbe4;
      text-shadow: 2px 2px 5px #FF69B4;
      margin: 0 0 10px 0;
    }

    .panel {
      max-width: 1040px;
      background: rgba(255,255,255,0.75);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      backdrop-filter: blur(2px);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    input[type="text"] {
      padding: 10px 12px;
      min-width: 320px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.2);
      font-family: inherit;
      font-size: 1.05em;
    }

    button, select {
      padding: 8px 10px;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.85);
      font-family: inherit;
      font-size: 1.0em;
      color: blue;
    }

    button:hover {
      background: rgba(255,255,255,1);
    }

    a, a:visited, a:active {
      color: #39FF14;
      text-decoration: none;
    }

    .muted { color: rgba(0,0,255,0.75); }
    .tiny { font-size: 0.95em; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    fieldset {
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 14px;
      padding: 10px 12px 12px;
      background: rgba(255,255,255,0.65);
    }

    legend {
      padding: 0 8px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .legend-actions {
      display: inline-flex;
      gap: 6px;
      margin-left: auto;
    }

    .legend-actions button {
      padding: 4px 8px;
      border-radius: 10px;
      font-size: 0.95em;
    }

    label {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 6px 0;
    }

    textarea {
      width: 100%;
      height: 84px;
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.2);
      font-family: inherit;
      font-size: 1.0em;
      color: blue;
      background: rgba(255,255,255,0.85);
    }

    .warn {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 230, 170, 0.55);
      border: 1px solid rgba(0,0,0,0.2);
      color: rgba(0,0,255,0.9);
      font-size: 1.0em;
    }
  </style>
</head>

<body>
  <div class="panel">
    <h2>Adam's search page :)</h2>

    <div class="row">
      <input id="term" type="text" placeholder='Search term (e.g. "tamagotchi")' />
      <button id="searchBtn">Search</button>
      <button id="copyBtn">Copy query</button>
      <span class="muted tiny">Tip: use quotes for exact phrases.</span>
      <span style="margin-left:auto;"></span>
      <a href="index.html">‚Üê back home</a>
    </div>

    <div class="row">
      <strong>Quick actions:</strong>
      <button data-action="all">Select all</button>
      <button data-action="none">Select none</button>
      <button data-action="invert">Invert</button>

      <span style="margin-left:10px;"></span>

      <strong>Tag filter:</strong>
      <select id="tagFilter">
        <option value="__all__">All tags</option>
      </select>

      <span class="muted tiny">Group All/None buttons are inside each group box.</span>
    </div>

    <div id="sitebookWarn" class="warn" style="display:none;"></div>

    <div class="grid" id="groups"></div>

    <textarea id="queryOut" readonly></textarea>
  </div>

  <script src="sites.js"></script>
  <script>
    /*
      Groups are your main buckets (from SITEBOOK.advancedGroups).
      Tags are optional extra metadata; tag filter is purely UI show/hide (does not change selection).
      Sites are sourced from window.SITEBOOK.sites where inAdvancedSearch === true.
    */

    // --- DOM ---
    const groupsEl = document.getElementById("groups");
    const tagFilterEl = document.getElementById("tagFilter");
    const queryOut = document.getElementById("queryOut");
    const termEl = document.getElementById("term");
    const warnEl = document.getElementById("sitebookWarn");

    function showWarn(msg){
      warnEl.textContent = msg;
      warnEl.style.display = "";
    }

    function normGroupList(site){
      // Supports either site.advancedGroups (array) or site.advancedGroup (string)
      if (Array.isArray(site.advancedGroups)) return site.advancedGroups.filter(Boolean);
      if (typeof site.advancedGroup === "string" && site.advancedGroup.trim()) return [site.advancedGroup.trim()];
      return [];
    }

    function normTags(site){
      return Array.isArray(site.tags) ? site.tags.filter(Boolean) : [];
    }

    function makeId(group, domain, siteId){
      const raw = `${group}__${siteId}__${domain}`;
      return "cb_" + raw.replace(/[^a-z0-9]/gi, "_");
    }

    function buildPublicationsFromSitebook(){
      const sb = window.SITEBOOK;
      if (!sb || !sb.sites) {
        showWarn("Sitebook failed to load (sites.js / window.SITEBOOK missing).");
        return { items: [], groupOrder: [], allTags: [] };
      }

      const groupOrder = Array.isArray(sb.advancedGroups) ? sb.advancedGroups.slice() : [];
      const items = [];

      for (const [siteId, site] of Object.entries(sb.sites)) {
        if (!site || !site.inAdvancedSearch) continue;
        const domain = site.domain;
        if (!domain) continue;

        const groups = normGroupList(site);
        const tags = normTags(site);
        const checkedByDefault = (site.defaultAdvanced !== false); // default true

        // If no group is set, still include it under a fallback
        const finalGroups = groups.length ? groups : ["(ungrouped)"];

        for (const g of finalGroups) {
          items.push({
            group: g,
            siteId,
            name: site.label || siteId,
            domain,
            tags,
            checkedByDefault
          });
        }
      }

      // Ensure fallback group exists at end if used
      if (items.some(x => x.group === "(ungrouped)") && !groupOrder.includes("(ungrouped)")) {
        groupOrder.push("(ungrouped)");
      }

      // Build tag list
      const tagSet = new Set();
      items.forEach(it => it.tags.forEach(t => tagSet.add(t)));
      const allTags = Array.from(tagSet).sort((a,b) => a.localeCompare(b));

      return { items, groupOrder, allTags };
    }

    function render(){
      groupsEl.innerHTML = "";

      const { items, groupOrder, allTags } = buildPublicationsFromSitebook();

      // rebuild tag dropdown (keep "All tags" at top)
      tagFilterEl.innerHTML = `<option value="__all__">All tags</option>`;
      allTags.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        tagFilterEl.appendChild(opt);
      });

      // group items
      const byGroup = new Map();
      items.forEach(it => {
        if(!byGroup.has(it.group)) byGroup.set(it.group, []);
        byGroup.get(it.group).push(it);
      });

      // keep group order stable and predictable
      const orderedGroups = groupOrder.filter(g => byGroup.has(g));
      // include any groups not listed (just in case), appended alphabetically
      const extraGroups = Array.from(byGroup.keys()).filter(g => !orderedGroups.includes(g));
      extraGroups.sort((a,b)=>a.localeCompare(b));
      const finalGroups = orderedGroups.concat(extraGroups);

      for (const group of finalGroups) {
        const groupItems = byGroup.get(group);

        const fs = document.createElement("fieldset");
        fs.dataset.group = group;

        const lg = document.createElement("legend");
        lg.innerHTML = `
          <span>${group}</span>
          <span class="legend-actions">
            <button type="button" data-group-action="all" data-group="${group}">All</button>
            <button type="button" data-group-action="none" data-group="${group}">None</button>
          </span>
        `;
        fs.appendChild(lg);

        // keep a stable order inside group: by name
        groupItems
          .slice()
          .sort((a,b) => a.name.localeCompare(b.name))
          .forEach(({name, domain, tags, group, siteId, checkedByDefault}) => {
            const id = makeId(group, domain, siteId);
            const lab = document.createElement("label");
            lab.dataset.tags = tags.join(",");
            lab.dataset.group = group;
            lab.innerHTML = `
              <input type="checkbox"
                    id="${id}"
                    data-domain="${domain}"
                    data-group="${group}"
                    ${checkedByDefault ? "checked" : ""} />
              <span><strong>${escapeHtml(name)}</strong>
                <span class="muted">(${escapeHtml(domain)})</span>
                <span class="muted">[${escapeHtml(tags.join(", "))}]</span>
              </span>
            `;
            fs.appendChild(lab);
          });

        groupsEl.appendChild(fs);
      }

      updateQuery();
      applyTagFilter();
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function selectedDomains(){
      // Include all checked boxes (even if hidden by tag filter).
      // De-duplicate domains so duplicates across groups don't repeat site: clauses.
      const domains = [...document.querySelectorAll('input[type="checkbox"][data-domain]')]
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.domain);

      return [...new Set(domains)];
    }

    function buildQuery(){
      const term = termEl.value.trim();
      const domains = selectedDomains();

      const siteClause = domains.length
        ? "(" + domains.map(d => `site:${d}`).join(" OR ") + ")"
        : "";

      return (term ? term + " " : "") + siteClause;
    }

    function updateQuery(){
      queryOut.value = buildQuery().trim();
    }

    function applyTagFilter(){
      const tag = tagFilterEl.value;
      const labels = [...document.querySelectorAll("label[data-tags]")];
      labels.forEach(lab => {
        if(tag === "__all__") { lab.style.display = ""; return; }
        const tags = (lab.dataset.tags || "").split(",").filter(Boolean);
        lab.style.display = tags.includes(tag) ? "" : "none";
      });
      // tag filter does NOT change selection; it only hides/shows rows.
    }

    // events
    document.addEventListener("change", (e) => {
      if(e.target.matches('input[type="checkbox"][data-domain]')) updateQuery();
      if(e.target === tagFilterEl) applyTagFilter();
    });

    document.addEventListener("click", (e) => {
      // global quick actions
      if (e.target.matches("button[data-action]")) {
        const action = e.target.dataset.action;
        const boxes = [...document.querySelectorAll('input[type="checkbox"][data-domain]')];
        if(action === "all") boxes.forEach(b => b.checked = true);
        if(action === "none") boxes.forEach(b => b.checked = false);
        if(action === "invert") boxes.forEach(b => b.checked = !b.checked);
        updateQuery();
        return;
      }

      // group actions
      if (e.target.matches("button[data-group-action]")) {
        const group = e.target.dataset.group;
        const action = e.target.dataset.groupAction;

        const boxes = [...document.querySelectorAll(`input[type="checkbox"][data-group="${CSS.escape(group)}"]`)];
        if(action === "all") boxes.forEach(b => b.checked = true);
        if(action === "none") boxes.forEach(b => b.checked = false);

        updateQuery();
        return;
      }
    });

    document.getElementById("searchBtn").addEventListener("click", () => {
      const q = buildQuery().trim();
      if(!q) return;
      window.open("https://www.google.com/search?q=" + encodeURIComponent(q), "_blank");
    });

    document.getElementById("copyBtn").addEventListener("click", async () => {
      const q = buildQuery().trim();
      if(!q) return;
      try { await navigator.clipboard.writeText(q); } catch {}
    });

    termEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter") document.getElementById("searchBtn").click();
    });

    render();
  </script>
</body>
</html>
